name: CI

on:
    push:
        branches: ["main"]
    pull_request:

jobs:
    user-service:
        runs-on: ubuntu-latest

        services:
            postgres:
                image: postgres:16
                env:
                    POSTGRES_USER: postgres
                    POSTGRES_PASSWORD: postgres
                    POSTGRES_DB: user_test
                ports:
                    - 5432:5432
                options: >-
                    --health-cmd "pg_isready -U postgres -d user_test"
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 10

        steps:
            - uses: actions/checkout@v4

            - uses: actions/setup-python@v5
              with:
                  python-version: "3.11"
                  cache: "pip"
                  cache-dependency-path: |
                      services/user-service/requirements.txt

            # Narzędzia repo (lint/format)
            - name: Install tooling
              run: |
                  python -m pip install --upgrade pip
                  pip install ruff black

            # Zależności serwisu
            - name: Install user-service deps
              working-directory: services/user-service
              run: |
                  pip install -r requirements.txt

            - name: Ruff lint
              run: ruff check .

            - name: Black format check
              run: black --check .

            - name: Wait for Postgres
              run: |
                  for i in {1..30}; do
                    pg_isready -h localhost -p 5432 -U postgres -d user_test && exit 0
                    sleep 1
                  done
                  echo "Postgres did not become ready in time" && exit 1

            - name: Run tests (user-service)
              working-directory: services/user-service
              env:
                  PYTHONPATH: .
                  ENV: ci
                  DATABASE_URL: "postgresql+psycopg://postgres:postgres@localhost:5432/user_test"
              run: |
                  pytest -q --maxfail=1 --cov=app --cov-report=term-missing --cov-fail-under=60 --disable-warnings
    catalog-service:
        runs-on: ubuntu-latest

        services:
            postgres:
                image: postgres:16
                env:
                    POSTGRES_USER: postgres
                    POSTGRES_PASSWORD: postgres
                    POSTGRES_DB: catalog_test
                ports:
                    - 5432:5432
                options: >-
                    --health-cmd "pg_isready -U postgres -d catalog_test"
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 10

        steps:
            - uses: actions/checkout@v4

            - uses: actions/setup-python@v5
              with:
                  python-version: "3.11"
                  cache: "pip"
                  cache-dependency-path: |
                      services/catalog-service/requirements.txt

            # Narzędzia repo (lint/format)
            - name: Install tooling
              run: |
                  python -m pip install --upgrade pip
                  pip install ruff black

            # Zależności serwisu
            - name: Install catalog-service deps
              working-directory: services/catalog-service
              run: |
                  pip install -r requirements.txt

            - name: Ruff lint
              run: ruff check .

            - name: Black format check
              run: black --check .

            - name: Wait for Postgres
              run: |
                  for i in {1..30}; do
                    pg_isready -h localhost -p 5432 -U postgres -d catalog_test && exit 0
                    sleep 1
                  done
                  echo "Postgres did not become ready in time" && exit 1

            - name: Run tests (catalog-service)
              working-directory: services/catalog-service
              env:
                  PYTHONPATH: .
                  ENV: ci
                  DATABASE_URL: "postgresql+psycopg://postgres:postgres@localhost:5432/catalog_test"
              run: |
                  pytest -q --maxfail=1 --cov=app --cov-report=term-missing --cov-fail-under=60 --disable-warnings
    circulation-service:
        runs-on: ubuntu-latest

        services:
            postgres:
                image: postgres:16
                env:
                    POSTGRES_USER: postgres
                    POSTGRES_PASSWORD: postgres
                    POSTGRES_DB: circulation_test
                ports:
                    - 5432:5432
                options: >-
                    --health-cmd "pg_isready -U postgres -d circulation_test"
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 10

        steps:
            - uses: actions/checkout@v4

            - uses: actions/setup-python@v5
              with:
                  python-version: "3.11"
                  cache: "pip"
                  cache-dependency-path: |
                      services/circulation-service/requirements.txt

            # Narzędzia repo (lint/format)
            - name: Install tooling
              run: |
                  python -m pip install --upgrade pip
                  pip install ruff black

            # Zależności serwisu
            - name: Install circulation-service deps
              working-directory: services/circulation-service
              run: |
                  pip install -r requirements.txt

            - name: Ruff lint
              run: ruff check .

            - name: Black format check
              run: black --check .

            - name: Wait for Postgres
              run: |
                  for i in {1..30}; do
                    pg_isready -h localhost -p 5432 -U postgres -d circulation_test && exit 0
                    sleep 1
                  done
                  echo "Postgres did not become ready in time" && exit 1

            - name: Run tests (circulation-service)
              working-directory: services/circulation-service
              env:
                  PYTHONPATH: .
                  ENV: ci
                  DATABASE_URL: "postgresql+psycopg://postgres:postgres@localhost:5432/circulation_test"
                  SERVICE_JWT: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwiZXhwIjo0OTIwMDE1ODY3LCJyb2xlIjoiQURNSU4iLCJpc3MiOiJsbXMtdXNlci1zZXJ2aWNlIiwiYXVkIjoibG1zIn0.ifedPtkCO60IKtm4XgkTLedy-b_85pM72ibDMFnPnyY"
              run: |
                  pytest -q --maxfail=1 --cov=app --cov-report=term-missing --cov-fail-under=60 --disable-warnings
